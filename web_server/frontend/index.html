<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Robot Live Stream</title>
<style>
    body { text-align: center; font-family: sans-serif; background: #111; color: #eee; }
    img {
        width: 80vw;
        max-width: 100%;
        height: auto;
        border: 2px solid #555;
        border-radius: 6px;
        margin-top: 20px;
        }
    #status { margin-top: 10px; font-size: 1.1em; }
</style>
</head>
<body>
<h1>Robot Camera</h1>
<div style="text-align:center;">
  <img id="stream" src="" alt="Waiting for stream..." />
</div>
<div id="status">Connecting...</div>

<script>
const imgEl = document.getElementById('stream');
const statusEl = document.getElementById('status');

const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(`${protocol}//${location.host}`);

ws.onopen = () => statusEl.textContent = 'Connected';
ws.onclose = () => statusEl.textContent = 'Disconnected';
ws.onerror = (err) => console.error('WebSocket error', err);

let oldBlobUrl = null;

ws.onmessage = (event) => {
  try {
    const payload = JSON.parse(event.data);
    if (payload.type === 'image' && payload.data) {
      // Convert base64 to Uint8Array
      const byteCharacters = atob(payload.data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);

      // Create a Blob and Object URL
      const blob = new Blob([byteArray], { type: 'image/jpeg' });
      const blobUrl = URL.createObjectURL(blob);

      // Set image source and revoke old URL
      imgEl.src = blobUrl;
      if (oldBlobUrl) {
        URL.revokeObjectURL(oldBlobUrl);
      }
      oldBlobUrl = blobUrl;
    }
  } catch (e) {
    console.error('Failed to parse message', e);
  }
};
</script>
</body>
</html>